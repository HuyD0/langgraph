# Agent deployment pipeline - Direct Python scripts (RECOMMENDED)
# 
# This version uses direct Python entry points (cleaner and faster than CLI).
# All tasks use serverless compute following Databricks best practices.
# Reference: https://docs.databricks.com/aws/en/dev-tools/bundles/examples#job-that-uses-serverless-compute
#
resources:
  jobs:
    agent_deployment_pipeline_v2:
      name: ${bundle.target}_agent_deployment_v2
      
      # Run as the user who has access to endpoints
      run_as:
        user_name: ${var.user_email}
      
      tasks:
        - task_key: register_model
          python_wheel_task:
            package_name: langgraph_mcp_agent
            entry_point: register_model
            named_parameters:
              experiment_name: ${var.experiment_name}
          environment_key: serverless_env
        
        - task_key: validate_model
          depends_on:
            - task_key: register_model
          python_wheel_task:
            package_name: langgraph_mcp_agent
            entry_point: evaluate_model
          environment_key: serverless_env
        
        - task_key: deploy_to_serving
          depends_on:
            - task_key: validate_model
          python_wheel_task:
            package_name: langgraph_mcp_agent
            entry_point: deploy_model
            named_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              model_name: ${var.model_name}
          environment_key: serverless_env
      
      # Environment spec for serverless compute
      environments:
        - environment_key: serverless_env
          spec:
            environment_version: '2'
            dependencies:
              - /Workspace/Users/${var.user_email}/.bundle/langgraph/dev/artifacts/.internal/langgraph_mcp_agent-0.1.0-py3-none-any.whl
      
      tags:
        project: langgraph-mcp-agent
        environment: ${bundle.target}
        managed_by: databricks-asset-bundle
      
      max_concurrent_runs: 1
