# Agent deployment pipeline - complete deployment workflow
# Registers model, validates it, and deploys to serving endpoint
resources:
  jobs:
    agent_deployment_pipeline:
      name: ${bundle.target}_agent_deployment_pipeline
      
      # Run as the user who has access to endpoints
      run_as:
        user_name: ${var.user_email}
      
      tasks:
        - task_key: register_model
          python_wheel_task:
            package_name: langgraph_mcp_agent
            entry_point: langgraph_mcp_agent
            parameters:
              - "register"
              - "--model-code"
              - "."
              - "--validate"
          environment_key: default_env
        
        - task_key: validate_model
          depends_on:
            - task_key: register_model
          python_wheel_task:
            package_name: langgraph_mcp_agent
            entry_point: langgraph_mcp_agent
            parameters:
              - "evaluate"
              # Dataset will be loaded from Unity Catalog automatically
          environment_key: default_env
        
        - task_key: deploy_to_serving
          depends_on:
            - task_key: validate_model
          python_wheel_task:
            package_name: langgraph_mcp_agent
            entry_point: langgraph_mcp_agent
            parameters:
              - "deploy"
              - "--catalog"
              - "${var.catalog}"
              - "--schema"
              - "${var.schema}"
              - "--model-name"
              - "${var.model_name}"
          environment_key: default_env
      
      environments:
        - environment_key: default_env
          spec:
            client: "1"
            dependencies:
              - "/Workspace/Users/huy.d@hotmail.com/.bundle/langgraph/dev/artifacts/.internal/langgraph_mcp_agent-0.1.0-py3-none-any.whl"
      
      tags:
        project: langgraph-mcp-agent
        environment: ${bundle.target}
        managed_by: databricks-asset-bundle
      
      max_concurrent_runs: 1
